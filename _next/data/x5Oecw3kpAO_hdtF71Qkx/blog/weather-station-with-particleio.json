{"pageProps":{"frontmatter":{"title":"Building your own Weather station with Particle Electron","date":"Fed 8th, 2019","excerpt":"Building your own weather station with Arduino family micro controller","cover_image":"https://github.com/datduyng/datduyng.github.io/blob/2170af7581dc2fe4fd411549f84ae1785671faaa/assets/img/post/2019-03-10-hmm-graphical.png?raw=true"},"slug":"weather-station-with-particleio","content":"\n**Layout:** \n\n- [cover_image: '[/images/posts/img3.jpg](https://github.com/datduyng/datduyng.github.io/blob/2170af7581dc2fe4fd411549f84ae1785671faaa/assets/img/post/2019-02-08-weather-station-01.png?raw=true)'](#cover_image-imagespostsimg3jpghttpsgithubcomdatduyngdatduynggithubioblob2170af7581dc2fe4fd411549f84ae1785671faaaassetsimgpost2019-02-08-weather-station-01pngrawtrue)\n  - [I Introduction](#i-introduction)\n    - [1. Particle Electron](#1-particle-electron)\n    - [2. ThingSpeak](#2-thingspeak)\n  - [II. Weather station Project layout](#ii-weather-station-project-layout)\n    - [1. Components](#1-components)\n    - [2. Wiring](#2-wiring)\n    - [3. Particle Connection](#3-particle-connection)\n      - [Particle Mode](#particle-mode)\n    - [4. ThingSpeak connection](#4-thingspeak-connection)\n    - [5. Weather database connection](#5-weather-database-connection)\n  - [III. Final product](#iii-final-product)\n  - [IV.References](#ivreferences)\n\n### I Introduction\nIf you a type of person who like to work with Arduino project, then I have something for you. As a person who like to work with Arduino, I always wanted to find a way to connect arduino to the internet and some how view live sensors data. Roughly last year, My professor urged me to put together a Arduino end to end project that can connect to the internet and visualize sensor data via [ThingSpeak](https://thingspeak.com/). \nI designed a weather station control by Arduino and connect to Thingspeak using internet module, [Particle Electron](https://www.particle.io/cellular/). The weather station constantly query a weather database, [openweathermap.org](https://openweathermap.org/) to smooth out the sensor value and get a better approximation of the weather. \n\n#### 1. Particle Electron\nParticle Electron is a tiny microcontroller about the size of an Arduino Nano for creating 3-G cellular- connnected electronics projects and products. The particle electron box come with a SIM card, antenna, and battery as main components. The Particle electron look like as below: \n\n\n<p align=\"center\"><img src=\"https://user-images.githubusercontent.com/35666615/52460095-50775a80-2b2e-11e9-82bb-f80e2c67d18f.jpg\"></p>\n\nParticle Electron can be power through the 5V power jack or straight from the battery provided in the packages. \n\n#### 2. ThingSpeak\nOne of my favorite section to discuss about. I had to much fun exploring this website so let's jump right in. \nThingSpeak is a free web service that let's you collect and store sensor data in the cloud and develop internet of thing application. The Thingspeak web services provide tool that let you analyze and visualize data on their website. Most app and service on Thingspeak is run completely with MATLAB, a easy to pick language for data processing and visualization. \nThingspeak is more than just a free web service. They create a rigid communities. I love being a part of Arduino communites opensource project. This thought really give me a feeling of beloning to the ThinkSpeak communities.\n\nChannels can be public or kept private. Below are picture showing example of a public channel. \n<p align=\"center\"><img height=\"500\" width=\"550\" src=\"https://user-images.githubusercontent.com/35666615/52460524-5ec67600-2b30-11e9-97df-2419456bfa30.PNG\"><img height=\"500\" width=\"550\" src=\"https://user-images.githubusercontent.com/35666615/52460527-6128d000-2b30-11e9-899a-cf1e8efaccff.PNG\"></p>\n\nAlright it is not enough of the talking business so let's jump right in.\n### II. Weather station Project layout\nLink to our weather station project: [https://github.com/datduyng/particle-iot-weather-station](https://github.com/datduyng/particle-iot-weather-station)\nFlow chart of the project:\n<p align=\"center\"><img height=\"550\" width=\"670\" src=\" https://user-images.githubusercontent.com/35666615/51284584-9f0f5a00-19b1-11e9-9326-608e5ffdcf01.jpg\"></p>\n\nSome part on the chart to note:  here particle Electron is an independent node as in future we might want to be able to add sub-node like more Arduino and more raspberry pi. \n\n\n#### 1. Components\n- [Arduino uno](https://store.arduino.cc/usa/arduino-uno-rev3)/\n- [Paticle Electron](https://store.particle.io/collections/electron)\n- [Weather meter](https://www.sparkfun.com/products/8942)\n- [Sparkfun Weather meter Shield](https://www.sparkfun.com/products/13956)\n- Project water proof enclosure.\n\nIn this project, I use the Sparkfun weather station shield, which is packed with a humidity and temperature sensor in it. This https://user-images.githubusercontent.com/35666615/52514662-6f7ef680-2bd9-11e9-8ba0-ad4a5964d5ea.pngsave me huge amount of wiring and coding times. \n\n#### 2. Wiring\nConnection between arduino to Particle is via I2c bus. \n-   `SDA(arduino) -> SDA(electron-pinD0)`\n-   `SCL(arduino) -> SCL(electron-pinD1)`\n\nBelow is the pinout of Arduino(left) and Particle electron(right)\n<p align=\"center\"><img height=\"400\" width=\"480\" src=\"https://user-images.githubusercontent.com/35666615/52514653-6130da80-2bd9-11e9-85f0-df561c31529a.png\"><img height=\"400\" width=\"480\" src=\"https://user-images.githubusercontent.com/35666615/52514662-6f7ef680-2bd9-11e9-8ba0-ad4a5964d5ea.png\"></p>\n\nThe weather shield would just plug straight on the Arduino so that is easy. \n> <p align=\"center\"><img height=\"400\" width=\"480\" src=\"https://user-images.githubusercontent.com/35666615/42290717-b720172a-7f8c-11e8-975b-02a0eb231c07.jpg\"></p>\nNote: above the gray wire with 'R' tag stand for 'raingauge' and 'W' stand for 'Windspeed' are the input of the Sparkfun weather meters. \n\n#### 3. Particle Connection\n\n##### Particle Mode\nParticle is a multi purpose device. It has a bunch of mode[(particle mode)](https://docs.particle.io/tutorials/device-os/led/electron/). Few mode that you need to be familiar is\n- Connected mode \n\t- When it is breathing cyan, your Electron is happily connected to the Internet. When it is in this mode, you can call functions and flash code.\n- Looking for the internet\n\t-\tIf Electron is blinking, then It is trying to connect to Cellular. \n- Safe mode\n\t- Safe mode, breathing magenta (red and blue at the same time), connects the Electron to the cloud, but does not run any application firmware\n\nParticle website allow you to download library and upload code right on the cloud. In this project, The Particle only need to include the 'ThingSpeak' library(Since the particle is a bridge device between 'the ground' and 'the cloud'). So make sure you have downloaded the library. \n\nLooking at our flow chart we are currently interested in the Arduino to particle part as shown below.\n<center><img height=\"400\" width=\"480\" src=\"https://user-images.githubusercontent.com/35666615/52515101-51b39080-2bdd-11e9-80b5-9e054bcb5120.PNG\"> </center>\n\nEx: I2c connection from Arduino to Particle\nNote: copy this code straight in to your IDE will not compile. Refer to my github for runnable code.\n\nIn this project, We used the Arduino as Master and Particle as slave. \n```c++\n#include<Wire.h> // i2c Communication\n\n// Here you would define the address of the \n// SLAVE. why in byte?? max of a byte is 2^8 = 255 \n// this mean that I2C communication is valid for only\n// 255 node(module)\nbyte SLAVE_ADDRESS = 8;\n\n// here buff is the package. We need to append\n// all sensor values into one big string.\n// or one big string package\nint packageLength = 255;\nchar buff[255];\n\n// this indicate the period you would like to send\n// your data to the particle. Design this carefully, \n// here: 2000 mean that the Arduino will send data to particle\n// every 2 seconds(2000 ms)\n#define period_between_data 2000\nlong last_send = 0;\n\n// NOTE: it is good to define sensor value as global \n// variable. So ALL function can view it.(You can use the variable in all scopes of the program)\nint sensor_value1 = 0;\nint sensor_value2 = 0; \n\nint update_sensor1(){\n\t// write some code to update sensor value here\n\treturn 0;\n}\n\nvoid setup(){\n\tSerial.begin(9600); // as usual just open the display usb port\n\tWire.begin(); // join all the i2c connection\n}\n\nvoid loop(){\n\t// read and update data sensor here\n\tsensor_value1 = update_sensor1();\n\n\tif((millis() - last_send) > period_between_data){\n\t\tlast_send = millis(); // update the time you last send\n\t\tsnprintf(buff, packageLength, \"%d;%d\", sensor_value1,sensor_value2);\n\t\t//ex: buff = \"12;234\";\n\n\t\t// send data to Particle\n\t\tWire.beginTransmission(SLAVE_ADDRESS);\n\t    Wire.write(buff);// send the package\n\t    Wire.endTransmission();\n\t}\n}\n```\n\n#### 4. ThingSpeak connection\nNow, we can create an account and setup our thingspeak webserver. This [blog](https://roboindia.com/tutorials/thingspeak-setup) does a really good job of step by step on setting up Thingspeak. \nHere we are interested in the connection from the Particle electron to Thingspeak webserver. \n> <center><img height=\"200\" width=\"400\" src=\"https://user-images.githubusercontent.com/35666615/52515304-5a0ccb00-2bdf-11e9-97f1-c53235621c72.PNG\"></center>\n\nCode can be write in [particle online IDE](https://build.particle.io/build)\n\n\nWe can set our program to send sensor data to thing speak using `Thingspeak.setField` function. Let's take a closer look at the function prototype: \n- setField take a `int field` value and a values. field below is shown as 1, 2, 3 represent ThingSpeak Field.\n```c++\n  ThingSpeak.setField(1,String(sensor_value1));//temp\n  ThingSpeak.setField(2,String(sensor_value2));//humd\n  ThingSpeak.setField(3,String(sensor_value3));//rain\n\n  // Write the fields that you've set all at once.\n  ThingSpeak.writeFields(myChannelID, myWriteAPIKey);\n```\n\nOn the side, you can also send sensors data to particle.io console via `Particle.publish()` function. \n\n#### 5. Weather database connection \nThe idea behind using a weather database is to have a more sensor value accuracy. In our project, we only use one weather live database. To get a more accuracy, one can query multiple live database and average all out. \nIn our project, we used [openweathermap.org](https://openweathermap.org/) API. As a free plan, they allows individual to have 60 API calls per minutes. \nThingspeak allow users to integrate apps to their projects. In this case, I ultilize the [React](https://thingspeak.com/apps/reacts) ThingSpeak apps. \nEverytime, Thingspeak receive sensors value, we have React setup so that It would query the openweathermap.org for current sensor value and average out our actual sensor values.\n\nTo Query weather datas from openweathermap.org, we can use MATLAB `webread()` function.  Refer to [openweathermap.org](https://openweathermap.org/current) on constructing api to query data for your location. Below is usage example of querying data from weather database:\n```matlab\n%NOTE: this url below is API that query value\n% for my location. TODO: change this line below\napi = 'https://api.openweathermap.org/data/2.5/weather?id=5034652&appid=3551223b0f56ff975fe725c7c49e8a64'\n\n%query data from api\ndataFromDb = webread(api)\n``` \nafter querying, `datafromDb` variable will hold a struct and would look like below:\n```matlab\ndataFromDb =\n\t\tstruct with fields:\n\t\tcoord: [1×1 struct]\n\t\tweather: [1×1 struct]\n\t\tbase: 'stations'\n\t\tmain: [1×1 struct]\n\t\tvisibility: 16093\n\t\twind: [1×1 struct]\n\t\tclouds: [1×1 struct]\n\t\tdt: 1.5342e+09\n\t\tsys: [1×1 struct]\n\t\tid: 5034652\n\t\tname: 'Lincoln County'\n\t\tcod: 200\n```\n### III. Final product\nNote picture shown below are not what describe above. I do not have original design of the project saved. Pictures below show an improvement version. Same idea apply as above. I only swap out the Arduino Uno with a Nano and add a circuit board for convinient. \n\n> <img height=\"380\" width=\"410\" src=\"https://user-images.githubusercontent.com/35666615/52516027-d0162f80-2be9-11e9-89e3-e8d4f18ce4be.jpg\"><img height=\"380\" width=\"410\" src=\"https://user-images.githubusercontent.com/35666615/52516034-dd331e80-2be9-11e9-95c6-4bd4d4512e73.jpg\"> \n\n\nHave fun exploring. I would appreciated any feedback thank you. \n\n### IV.References\n\n- https://www.mathworks.com/help/thingspeak/\n- https://openweathermap.org/\n- https://docs.particle.io/electron/\n- https://roboindia.com/tutorials/thingspeak-setup"},"__N_SSG":true}